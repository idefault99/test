# syntax=docker/dockerfile:1

FROM gradle:8.7-jdk21 AS publish
WORKDIR /home/gradle/project

# --- build args (придут из CI) ---
ARG VERSION=1.0.0-SNAPSHOT
ARG NEXUS_RELEASES_URL
ARG NEXUS_SNAPSHOTS_URL
ARG NEXUS_USER
ARG NEXUS_PASSWORD

# Чтобы Gradle из build.gradle увидел env-переменные:
ENV VERSION=$VERSION \
    NEXUS_RELEASES_URL=$NEXUS_RELEASES_URL \
    NEXUS_SNAPSHOTS_URL=$NEXUS_SNAPSHOTS_URL \
    NEXUS_USER=$NEXUS_USER \
    NEXUS_PASSWORD=$NEXUS_PASSWORD

# Кеши Gradle (ускорит повторные сборки)
ENV GRADLE_USER_HOME=/home/gradle/.gradle

# Сначала только gradle-файлы (кеш зависимостей)
COPY --chown=gradle:gradle settings.gradle build.gradle ./
RUN gradle --no-daemon help

# Потом исходники
COPY --chown=gradle:gradle src ./src

# Публикация в Nexus
RUN gradle --no-daemon clean publish

# Финальный stage не обязателен, но пусть будет "пустышка"
FROM alpine:3.20
CMD ["sh", "-c", "echo Published to Nexus successfully"]
