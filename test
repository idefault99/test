TAG: features-devops
REGISTRY_URL: harbor.sogaz.ru
ENVIRONMENT: test

INGRESS_BASE:  data-access-service-test.sogaz.ru
INGRESS_CLASS_NAME: ingress-data-access-service
IMAGE_PULL_SECRETS: sogaz

RESTART_POLICY: Always
REPLICA: 1

R_INIT_DELAY: 180
R_PERIOD: 30
L_INIT_DELAY: 240
L_PERIOD: 30

namespace: umka

secret:
  openbao: umka-secret

app:
  name: data-access
  port: 8080

# PostgreSQL connection settings
postgres:
  host: s00-0000-uk01.sogaz.ru
  port: 5432
  database: access_service_db
  username: access_service_user
  
  # HikariCP connection pool settings
  hikari:
    maximumPoolSize: 10
    minimumIdle: 5
    connectionTimeout: 30000  # 30 seconds
    idleTimeout: 600000       # 10 minutes
    maxLifetime: 1800000      # 30 minutes

# JPA/Hibernate settings
jpa:
  hibernateDdlAuto: validate  # Options: none, validate, update, create, create-drop
  showSql: false
  formatSql: true
  useSqlComments: true

# Logging levels
logging:
  level:
    root: INFO
    springframework: INFO
    hibernate: WARN
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.app.name }}-config
  namespace: {{ .Values.namespace }}
  labels:
    app: {{ .Values.app.name }}
data:
  # Database connection settings
  SPRING_DATASOURCE_URL: "jdbc:postgresql://postgresql.postgresql-data-access.svc.cluster.local:5432/access_service_db"
  SPRING_DATASOURCE_USERNAME: "access_service_user"
  SPRING_DATASOURCE_DRIVER_CLASS_NAME: "org.postgresql.Driver"
  
  # Connection pool settings
  SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "10"
  SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "5"
  SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT: "30000"
  SPRING_DATASOURCE_HIKARI_IDLE_TIMEOUT: "600000"
  SPRING_DATASOURCE_HIKARI_MAX_LIFETIME: "1800000"
  
  # JPA/Hibernate settings
  SPRING_JPA_HIBERNATE_DDL_AUTO: "validate"
  SPRING_JPA_SHOW_SQL: "false"
  SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: "org.hibernate.dialect.PostgreSQLDialect"
  SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL: "true"
  SPRING_JPA_PROPERTIES_HIBERNATE_USE_SQL_COMMENTS: "true"
  
  # Application settings
  SERVER_PORT: "8080"
  SPRING_APPLICATION_NAME: "data-access"
  
  # Logging
  LOGGING_LEVEL_ROOT: "INFO"
  LOGGING_LEVEL_ORG_SPRINGFRAMEWORK: "INFO"
  LOGGING_LEVEL_ORG_HIBERNATE: "WARN"
---
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: data-access-service
spec:
  selector:
    matchLabels:
      app: data-access-service
  replicas: {{ .Values.REPLICA }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: data-access-service
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: "/actuator/prometheus"
        prometheus.io/port: "8080"
    spec:
      containers:
        - image: {{ .Values.REGISTRY_URL }}/corphealth/data-access-service:{{ .Values.TAG }}
          imagePullPolicy: Always
          name: data-access-service
          ports:
            - containerPort: 8080
          envFrom:
            - configMapRef:
                name: {{ .Values.app.name }}-config
            - secretRef:
                name: {{ .Values.secret.openbao }}
          resources:
            requests:
              cpu: 1000m
              memory: 2Gi
            limits:
              cpu: 1000m
              memory: 2Gi
          # readinessProbe:
          #   httpGet:
          #     path: /actuator/health/readiness
          #     port: 8080
          #   initialDelaySeconds: {{ .Values.R_INIT_DELAY }}
          #   periodSeconds: {{ .Values.R_PERIOD }}
          # livenessProbe:
          #   httpGet:
          #     path: /actuator/health/liveness
          #     port: 8080
          #   initialDelaySeconds: {{ .Values.L_INIT_DELAY }}
          #   periodSeconds: {{ .Values.L_PERIOD }}
      restartPolicy: {{ .Values.RESTART_POLICY }}
---
apiVersion: v1
kind: Service
metadata:
  name: data-access-service
  labels:
    app: data-access-service
    metrics: enabled
spec:
  type: ClusterIP
  ports:
    - name: data-access-service
      port: 8080
      targetPort: 8080
      protocol: TCP
  selector:
    app: data-access-service
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  labels:
    app.kubernetes.io/name: umka
  name: umka
  namespace: umka
spec:
  refreshInterval: 1m
  secretStoreRef:
    kind: SecretStore
    name: vault-k8s
  target:
    creationPolicy: Owner
    name: umka-secret
  dataFrom: 
    - extract:
        key: umka/umka-backend
