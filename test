data_dir: /var/lib/vector

api:
  enabled: true
  address: 0.0.0.0:8687

sources:
  vuln_input:
    type: socket
    address: 0.0.0.0:6514
    mode: tcp
    decoding:
      codec: json
    framing:
      method: newline_delimited

  ingest_http:
    type: http_server
    address: 0.0.0.0:8686
    path: /ingest
    encoding: json

  rabbit:
    type: amqp
    connection_string: "amqp://dev:dev@haproxy:5672/%2f"
    queue: "USK-DisPult"
    acknowledgements: true
    decoding:
      codec: json

transforms:
  normalize:
    type: remap
    inputs: ["vuln_input", "ingest_http", "rabbit"]
    source: |
      .@timestamp = now()

      # Убираем запрещённое мета-поле _id, если его прислали
      if exists(._id) {
        .doc_id = del(._id)
      }

      # (опционально) если у тебя иногда прилетает timestamp в строке и ломает маппинг,
      # лучше сохранять его отдельно. Если timestamp уже число — оставим как есть.
      if exists(.timestamp) && is_string(.timestamp) {
        .original_timestamp = .timestamp
        del(.timestamp)
      }

      if !exists(.service) { .service = "vector" }

      if !exists(.host) {
        .host, err = get_hostname()
        if err != null { .host = "unknown" }
      }

  route:
    type: route
    inputs: ["normalize"]   # ВАЖНО: не "rabbit"
    route:
      policy: .stream == "policy"
      policy_lpu: .stream == "policy-lpu"
      policy_lpu_services: .stream == "policy-lpu-services"
      policy_program: .stream == "policy-program"

sinks:
  # Debug: что реально выходит из normalize
  console_debug:
    type: console
    inputs: ["normalize"]
    encoding:
      codec: json

  # Общий индекс со всем входящим (можешь потом отключить, если не нужен)
  opensearch_logs:
    type: elasticsearch
    inputs: ["normalize"]
    endpoints: ["http://opensearch:9200"]
    api_version: v7
    bulk:
      index: "vuln_input-%Y.%m.%d"
      action: "index"
    buffer:
      type: memory
      max_events: 5000

  # Раздельные индексы по stream
  policy:
    type: elasticsearch
    inputs: ["route.policy"]
    endpoints: ["http://opensearch:9200"]
    api_version: v7
    bulk:
      index: "usk-dispult-policy"
      action: "index"

  policy_lpu:
    type: elasticsearch
    inputs: ["route.policy_lpu"]
    endpoints: ["http://opensearch:9200"]
    api_version: v7
    bulk:
      index: "usk-dispult-policy-lpu"
      action: "index"

  policy_lpu_services:
    type: elasticsearch
    inputs: ["route.policy_lpu_services"]
    endpoints: ["http://opensearch:9200"]
    api_version: v7
    bulk:
      index: "usk-dispult-policy-lpu-services"
      action: "index"

  policy_program:
    type: elasticsearch
    inputs: ["route.policy_program"]
    endpoints: ["http://opensearch:9200"]
    api_version: v7
    bulk:
      index: "usk-dispult-policy-program"
      action: "index"
