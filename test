stages: [publish]

publish_to_nexus:
  stage: publish
  image: docker:27
  services:
    - name: docker:27-dind
      command: ["--mtu=1460"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_TAG'
  script:
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        VERSION="$CI_COMMIT_TAG"
      else
        VERSION="1.0.0-${CI_COMMIT_SHORT_SHA}-SNAPSHOT"
      fi

      docker build \
        --build-arg VERSION="$VERSION" \
        --build-arg NEXUS_RELEASES_URL="$NEXUS_RELEASES_URL" \
        --build-arg NEXUS_SNAPSHOTS_URL="$NEXUS_SNAPSHOTS_URL" \
        --build-arg NEXUS_USER="$NEXUS_USER" \
        --build-arg NEXUS_PASSWORD="$NEXUS_PASSWORD" \
        -t umka-dto-publisher:ci .
