# Multi-stage image build to create a final image without uv

# Build the application in the `/app` directory
FROM nexus.sogaz.ru/python:3.12.7-slim-bookworm AS builder

RUN pip install uv \
    --index-url http://nexus.sogaz.ru/repository/pypi-group/simple \
    --trusted-host nexus.sogaz.ru

ENV UV_COMPILE_BYTECODE=1 UV_LINK_MODE=copy

# Disable Python downloads, because we want to use the system interpreter
# across both images
ENV UV_PYTHON_DOWNLOADS=0

WORKDIR /app
RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    uv sync --locked --no-install-project --no-dev --index-strategy unsafe-best-match
COPY . /app
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --locked --no-dev


# Use a final image without uv
FROM nexus.sogaz.ru/python:3.12.7-slim-bookworm AS production
# It is important to use the image that matches the builder, as the path to the
# Python executable must be the same, e.g., using `python:3.11-slim-bookworm`
# will fail

WORKDIR /app
# Copy the application from the builder
COPY --from=builder --chown=app:app /app /app

# Place executables in the environment at the front of the path
ENV PATH="/app/.venv/bin:$PATH"

# Run the FastAPI application
CMD ["granian", "--no-log", "--interface", "asgi", "--host", "0.0.0.0", "src:app"]


# Install dev dependencies
FROM builder AS dev-builder
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --locked


# Use a final dev image without uv
FROM nexus.sogaz.ru/python:3.12.7-slim-bookworm AS development
# It is important to use the image that matches the builder, as the path to the
# Python executable must be the same, e.g., using `python:3.11-slim-bookworm`
# will fail

WORKDIR /app
# Copy the application from the builder
COPY --from=dev-builder --chown=app:app /app /app

# Place executables in the environment at the front of the path
ENV PATH="/app/.venv/bin:$PATH"

# Run the FastAPI application
#CMD ["granian", "--no-log", "--interface", "asgi", "--reload", "--host", "0.0.0.0", "src:app"]
CMD ["sh", "-c", "yoyo apply --batch --database postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@$POSTGRES_HOST:5432/$POSTGRES_DB migrations && granian --no-log --interface asgi --reload --host 0.0.0.0 src:app"]
