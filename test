data_dir: /var/lib/vector

api:
  enabled: true
  address: 0.0.0.0:8687

sources:
  vuln_input:
    type: socket
    address: 0.0.0.0:6514
    mode: tcp
#    tls:
#      enabled: true
#      crt_file: /etc/vector/tls/server.crt
#      key_file: /etc/vector/tls/server.key
#      ca_file: /etc/vector/tls/ca.crt
#      verify_certificate: true
    decoding:
      codec: json
    framing:
      method: newline_delimited

  ingest_http:
    type: http_server
    address: 0.0.0.0:8686
    path: /ingest
    encoding: json

  rabbit:
    type: amqp
    connection_string: "amqp://dev:dev@haproxy:5672/%2f"
    queue: "USK-DisPult"     #Очередь
    acknowledgements: true
    decoding:
      codec: json

transforms:
  normalize:
    type: remap
    inputs: ["vuln_input", "ingest_http", "rabbit"]
    source: |
      .@timestamp = now()

      if !exists(.service) { .service = "vector" }

      if !exists(.host) {
        .host, err = get_hostname()
        if err != null { .host = "unknown" }
      }

      if exists(._id) {
        .doc_id = del(._id)
      }
  route:
    type: route
    inputs: ["rabbit"]
    route:
      policy: '.stream == "policy"'
      policy_lpu: '.stream == "policy-lpu"'
      policy_lpu_services:  '.stream == "policy-lpu-services"'

sinks:
  console_debug:
    type: console
    inputs: ["normalize"]
    encoding:
      codec: json

  opensearch_logs:
    type: elasticsearch
    inputs: ["normalize"]
    endpoints: ["http://opensearch:9200"]

    api_version: v7

#    auth:
#      strategy: basic
#      user: admin
#      password: admin

#    tls:
#      ca_file: /etc/vector/tls/ca.crt
#      verify_certificate: true
#      verify_hostname: false

      # === mTLS ===
#      crt_file: /etc/vector/tls/client.crt
#      key_file: /etc/vector/tls/client.key

    bulk:
      index: "vuln_input-%Y.%m.%d"
      action: "index"

    buffer:
      type: memory
      max_events: 5000

  policy:
    type: elasticsearch
    inputs: ["route.policy"]
    endpoints: ["http://opensearch:9200"]
    api_version: v7
#    auth:
#      strategy: basic
#      user: admin
#      password: admin

#    tls:
#      ca_file: /etc/vector/tls/ca.crt
#      verify_certificate: true
#      verify_hostname: false

      # === mTLS ===
#      crt_file: /etc/vector/tls/client.crt
#      key_file: /etc/vector/tls/client.key

    bulk:
      index: "usk-dispult-policy"
      action: "index"

  policy_lpu:
    type: elasticsearch
    inputs: ["route.policy_lpu"]
    endpoints: ["http://opensearch:9200"]
    api_version: v7
#    auth:
#      strategy: basic
#      user: admin
#      password: admin

#    tls:
#      ca_file: /etc/vector/tls/ca.crt
#      verify_certificate: true
#      verify_hostname: false

      # === mTLS ===
#      crt_file: /etc/vector/tls/client.crt
#      key_file: /etc/vector/tls/client.key

    bulk:
      index: "usk-dispult-policy-lpu"
      action: "index"

  policy_lpu_services:
    type: elasticsearch
    inputs: ["route.policy_lpu_services"]
    endpoints: ["http://opensearch:9200"]
    api_version: v7
#    auth:
#      strategy: basic
#      user: admin
#      password: admin

#    tls:
#      ca_file: /etc/vector/tls/ca.crt
#      verify_certificate: true
#      verify_hostname: false

      # === mTLS ===
#      crt_file: /etc/vector/tls/client.crt
#      key_file: /etc/vector/tls/client.key

    bulk:
      index: "usk-dispult-policy-lpu-services"
      action: "index"

