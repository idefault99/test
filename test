include:
  - project: 'infrastructure/common/gitlab-ci'
    ref: master
    file: '/node/k8s/v100/.gitlab-ci.yml'
  - project: 'infrastructure/common/gitlab-ci'
    ref: master
    file: '/argocd/push-tag.yaml'

# 1) Создаём pipeline ТОЛЬКО для develop и release-*
# 2) Тут же задаём переменные окружения для develop (TEST).
workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: always
      variables:
        # целевое окружение для develop = TEST
        HELM_APP_ENV: ${HELM_APP_ENV_TEST}
        SERVICE_ENV: ${CI_ENV_TEST}
        SERVICE_HOST: ${CI_HOST_TEST}
        SERVICE_URL: ${CI_PROJECT_NAME}.${CI_DOMAIN_TEST}
        SERVICE_NAMESPACE: ${CI_NAMESPACE_TEST}
        KUBECONFIG_INTERNAL: ${KUBECONFIG_NEW_TEST}
        VITE_CONFIG: ${VITE_CONFIG_TEST}
        VITE_ENV: ${VITE_ENV_TEST}

    - if: '$CI_COMMIT_BRANCH =~ /^release-.*$/'
      when: always

    - when: never

# -------------------------
# Отключаем "лишние" джобы из include,
# чтобы в пайплайне develop/release-* не торчали init/lint/build и т.п.
# -------------------------
init:
  rules:
    - when: never

lint:
  rules:
    - when: never

build:
  rules:
    - when: never

deploy-future-bugfix:
  rules:
    - when: never

deploy-dev:
  rules:
    - when: never

stop_k8s_future-bugfix:
  rules:
    - when: never

# -------------------------
# BUILD: используем существующий build-kaniko из include
# включаем его только для develop и release-*
# -------------------------
build-kaniko:
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH =~ /^release-.*$/'
      when: on_success
    - when: never

# clone_ci_templates нужен для deploy jobs (они зависят от templates)
clone_ci_templates:
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH =~ /^release-.*$/'
      when: on_success
    - when: never

# -------------------------
# DEVELOP -> DEPLOY TEST (AUTO)
# используем существующий deploy_test из include, но меняем rules
# -------------------------
deploy_test:
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: on_success
    - when: never

# -------------------------
# RELEASE-* -> manual deploy STAGE
# В include нет отдельного stage-джоба под ваш процесс, добавляем ОДИН новый job.
# Скрипт — тот же helm upgrade, но с stage-переменными.
# -------------------------
deploy_stage:
  stage: deploy
  image: $CI_REPO_DOCKER/devth/helm:v3.12.3
  variables:
    EXCLUDE_FROM_LOGGING: false

    HELM_APP_ENV: ${HELM_APP_ENV_STAGE}
    SERVICE_ENV: ${CI_ENV_STAGE}
    SERVICE_HOST: ${CI_HOST_STAGE}
    SERVICE_URL: stage.${CI_PROJECT_NAME}.${CI_DOMAIN_STAGE}
    SERVICE_NAMESPACE: ${CI_NAMESPACE_STAGE}
    KUBECONFIG_INTERNAL: ${KUBECONFIG_NEW_TEST}
    VITE_CONFIG: ${VITE_CONFIG_STAGE}
    VITE_ENV: ${VITE_ENV_STAGE}

  dependencies:
    - clone_ci_templates

  before_script:
    - export SERVICE_URL_PATH=${CI_PATH_PREFIX}
    - echo $SERVICE_URL_PATH
    - export NEXT_PUBLIC_BASE_PATH=''
    - export SERVICE_PATH=$(echo "${CI_PATH_PREFIX}/${SERVICE_ENV}/${CI_PROJECT_NAME}/${CI_COMMIT_REF_SLUG}")
    - echo $SERVICE_PATH
    - export SHORT_CI_COMMIT_REF_NAME1=$(echo "$CI_COMMIT_REF_NAME" | cut -f1 -d"/" | tr '[:upper:]' '[:lower:]')
    - export SERVICE_NAME=${CI_PROJECT_NAME}-${SHORT_CI_COMMIT_REF_NAME1}
    - echo $SERVICE_NAME

  script:
    - mkdir -p ~/.kube
    - echo ${KUBECONFIG_INTERNAL} | base64 -d > ~/.kube/config
    - cp $LOCAL_TEMPLATE_REPO_PATH/helm/custom.json custom.json
    - envsubst < custom.json > ${HELM_CUSTOM_VALUES_FILE}
    - echo "${HELM_APP_ENV}" > helm_app_env.yml
    - helm upgrade --install
      ${CI_HELM_UPGRADE_FLAGS}
      --namespace ${SERVICE_NAMESPACE}
      --create-namespace
      -f ${HELM_CUSTOM_VALUES_FILE}
      -f helm_app_env.yml
      ${SERVICE_NAME} $LOCAL_TEMPLATE_REPO_PATH/helm/

  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^release-.*$/'
      when: manual
    - when: never

  allow_failure: true

# -------------------------
# RELEASE-* -> manual deploy PROD
# используем существующий deploy_prod_dmz / deploy_prod из include,
# но убираем master и оставляем только release-*.
# -------------------------
deploy_prod_dmz:
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^release-.*$/'
      when: manual
    - when: never

deploy_prod:
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^release-.*$/'
      when: manual
    - when: never
